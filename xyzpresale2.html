<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Presale</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }

        .container {
            max-width: 960px;
            margin: 20px auto;
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .wallet-section {
            text-align: right;
        }

        #connectWalletBtn {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        #connectWalletBtn:hover {
            background-color: #0056b3;
        }

        #walletAddressDisplay {
            margin-top: 10px;
            font-size: 0.9em;
            color: #555;
            word-break: break-all; /* For long addresses */
        }

        main {
            padding: 20px 0;
        }

        h2 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .presale-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }

        .buy-option {
            background-color: #28a745;
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .buy-option span {
            font-size: 0.8em;
            margin-top: 5px;
        }

        .buy-option:hover {
            background-color: #218838;
        }

        #transactionStatus {
            margin-top: 20px;
            text-align: center;
            font-weight: bold;
        }

        footer {
            text-align: center;
            padding-top: 20px;
            margin-top: 20px;
            border-top: 1px solid #eee;
            color: #777;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Solana Presale Event</h1>
            <div class="wallet-section">
                <button id="connectWalletBtn">Connect Solana Wallet</button>
                <p id="walletAddressDisplay" style="display:none;">Connected: <span id="walletAddress"></span></p>
            </div>
        </header>

        <main>
            <section id="presaleDashboard" style="display:none;">
                <h2>Buy Presale Tokens</h2>
                <div class="presale-options">
                    <button class="buy-option" data-sol="0.05" data-usd="5.00">Buy 0.05 SOL <span>(~<span class="xyz-tokens">...</span> XYZ)</span></button>
                    <button class="buy-option" data-sol="0.08" data-usd="8.00">Buy 0.08 SOL <span>(~<span class="xyz-tokens">...</span> XYZ)</span></button>
                    <button class="buy-option" data-sol="0.1" data-usd="10.00">Buy 0.1 SOL <span>(~<span class="xyz-tokens">...</span> XYZ)</span></button>
                    <button class="buy-option" data-sol="0.5" data-usd="50.00">Buy 0.5 SOL <span>(~<span class="xyz-tokens">...</span> XYZ)</span></button>
                    <button class="buy-option" data-sol="1.0" data-usd="100.00">Buy 1.0 SOL <span>(~<span class="xyz-tokens">...</span> XYZ)</span></button>
                </div>
                <div id="transactionStatus" style="margin-top: 20px;"></div>
            </section>

            <section id="notConnectedMessage" style="text-align: center; margin-top: 50px;">
                <p>Please connect your Solana wallet to view presale options.</p>
                <p>Ensure you have a Solana wallet browser extension like <a href="https://phantom.app/" target="_blank">Phantom</a> or <a href="https://solflare.com/" target="_blank">Solflare</a> installed.</p>
            </section>
        </main>

        <footer>
            <p>&copy; 2025 Solana Presale. All rights reserved.</p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";

        // --- Firebase Configuration ---
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBzr03ek43UYiSO5qVc1RGKLySDccgtYFE",
            authDomain: "quantcom-68a1f.firebaseapp.com",
            projectId: "quantcom-68a1f",
            storageBucket: "quantcom-68a1f.firebasestorage.app",
            messagingSenderId: "36123023094",
            appId: "1:36123023094:web:bb62a3df2d70ca0538bed7",
            measurementId: "G-JZHXTDHV2G"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app); // Get Firestore instance
        const analytics = getAnalytics(app); // Initialize Analytics

        // --- Solana Web3.js (loaded globally via script tag) ---
        // It's assumed solanaWeb3 is available globally from the script below.
        // If you absolutely need an ES module import for solanaWeb3,
        // you might need a build step or a different CDN that offers proper ESM.
    </script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>

    <script type="module">
        // Import Firestore and Firebase App if not already in the global scope from the previous script
        // Note: With type="module", these imports are scope-specific.
        // We ensure `app`, `db`, and `analytics` are accessible within this module.
        // If running this script as a separate file, you'd re-import them.
        // For a single HTML file with two module scripts, they share the same global environment once loaded.
        // However, it's cleaner to put all logic that depends on these imports within one module script.

        // Re-declaring for clarity, though they might be technically accessible if declared in the *first* module script.
        // Best practice would be to put *all* the script logic into *one* <script type="module"> block.
        // For this example, I'm adapting to your original split.
        // If `db` is not recognized, move `const db = getFirestore(app);` and other Firebase initializations
        // into this main script block.
        // Assuming `app` and `db` are correctly initialized and accessible here from the first module script.
        // If not, you'd need:
        // import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        // import { getFirestore } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        // const app = initializeApp(firebaseConfig); // (re-initialize or ensure global app instance)
        // const db = getFirestore(app);

        // Accessing the globally exposed solanaWeb3
        const solanaWeb3 = window.solanaWeb3;
        if (!solanaWeb3) {
            console.error("Solana Web3.js library not loaded. Ensure https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js is loaded correctly.");
        }

        // --- Solana Configuration ---
        const SOLANA_RPC_URL = "https://mainnet.helius-rpc.com/?api-key=ffa4267c-d28d-4bce-baf4-6cca12c26952";
        const DESTINATION_WALLET_ADDRESS = "99R4aBwwjXxeT9ukG2o1ppGE7GFEPqAWt94MvHhxoxgf"; // Your fixed destination address
        const XYZ_TOKEN_PRICE_USD = 0.004; // Price of 1 XYZ token in USD

        // --- DOM Elements ---
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const walletAddressDisplay = document.getElementById('walletAddressDisplay');
        const walletAddressSpan = document.getElementById('walletAddress');
        const presaleDashboard = document.getElementById('presaleDashboard');
        const notConnectedMessage = document.getElementById('notConnectedMessage');
        const transactionStatus = document.getElementById('transactionStatus');
        const buyOptionButtons = document.querySelectorAll('.buy-option');

        let provider; // To hold the wallet provider (e.g., Phantom, Solflare)
        let userWalletAddress = null; // To store the connected wallet address
        let solPriceUsd = null; // To store the current SOL price in USD

        // --- Functions ---

        // Function to fetch current SOL price
        async function fetchSolPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd');
                const data = await response.json();
                if (data && data.solana && data.solana.usd) {
                    solPriceUsd = data.solana.usd;
                    console.log("Current SOL Price (USD):", solPriceUsd);
                    updateXYZTokenAmounts(); // Update amounts once SOL price is fetched
                } else {
                    console.error("Failed to fetch SOL price from CoinGecko.");
                    solPriceUsd = 200; // Fallback to a default price if API fails
                    console.warn("Using fallback SOL price:", solPriceUsd);
                    updateXYZTokenAmounts();
                }
            } catch (error) {
                console.error("Error fetching SOL price:", error);
                solPriceUsd = 200; // Fallback
                console.warn("Using fallback SOL price:", solPriceUsd);
                updateXYZTokenAmounts();
            }
        }

        // Function to calculate and update XYZ token amounts on buttons
        function updateXYZTokenAmounts() {
            if (!solPriceUsd) {
                // If SOL price isn't fetched yet, set a placeholder or wait
                buyOptionButtons.forEach(button => {
                    const xyzSpan = button.querySelector('.xyz-tokens');
                    if (xyzSpan) xyzSpan.textContent = '...';
                });
                return;
            }

            buyOptionButtons.forEach(button => {
                const solAmount = parseFloat(button.dataset.sol);
                const solValueUsd = solAmount * solPriceUsd;
                const xyzTokens = solValueUsd / XYZ_TOKEN_PRICE_USD;
                const xyzSpan = button.querySelector('.xyz-tokens');
                if (xyzSpan) xyzSpan.textContent = xyzTokens.toLocaleString(undefined, { maximumFractionDigits: 2 });
            });
        }

        // Function to check for a Solana wallet provider (like Phantom or Solflare)
        async function getSolanaWalletProvider() {
            if ("solana" in window) {
                const solana = window.solana;
                if (solana.isPhantom) {
                    console.log("Phantom wallet found!");
                    return solana;
                }
            }
            if ("solflare" in window) {
                const solflare = window.solflare;
                 if (solflare.isSolflare) {
                    console.log("Solflare wallet found!");
                    return solflare;
                }
            }
            console.log("No Solana wallet (Phantom or Solflare) found. Please install one.");
            return null;
        }

        // Function to connect the wallet
        async function connectWallet() {
            transactionStatus.textContent = ''; // Clear previous messages
            try {
                provider = await getSolanaWalletProvider();

                if (provider) {
                    // Request connection to the wallet
                    const resp = await provider.connect();
                    userWalletAddress = resp.publicKey.toString();
                    console.log("Wallet connected:", userWalletAddress);

                    walletAddressSpan.textContent = userWalletAddress;
                    walletAddressDisplay.style.display = 'block';
                    connectWalletBtn.textContent = 'Wallet Connected';
                    connectWalletBtn.disabled = true; // Disable after connection

                    showPresaleDashboard();

                    // Save wallet address to Firestore
                    await saveWalletToFirestore(userWalletAddress);

                } else {
                    alert("Solana wallet not found. Please install Phantom or Solflare.");
                    // Open a new tab for Phantom or Solflare if not found
                    if (confirm("Would you like to install Phantom Wallet?")) {
                        window.open("https://phantom.app/", "_blank");
                    }
                }
            } catch (err) {
                // Handle error if user rejects connection or other issues
                console.error("Wallet connection failed:", err);
                alert("Wallet connection failed. Please ensure your wallet is unlocked and you approve the connection. Error: " + (err.message || err));
            }
        }

        // Function to save wallet address to Firestore
        async function saveWalletToFirestore(address) {
            try {
                // `db` is available from the first module script if initialized correctly
                // or if moved into this module script.
                const walletsRef = db.collection('connectedWallets');
                await walletsRef.doc(address).set({
                    address: address,
                    connectedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true }); // Use merge to update if already exists
                console.log("Wallet address saved to Firestore:", address);
            } catch (error) {
                console.error("Error saving wallet to Firestore:", error);
            }
        }

        // Function to show the presale dashboard and hide the connection message
        function showPresaleDashboard() {
            presaleDashboard.style.display = 'block';
            notConnectedMessage.style.display = 'none';
        }

        // Function to handle buy presale button clicks
        async function handleBuyPresale(event) {
            if (!userWalletAddress) {
                alert("Please connect your wallet first.");
                return;
            }
            if (!solPriceUsd) {
                alert("Please wait, fetching SOL price...");
                return;
            }

            const solAmount = parseFloat(event.target.dataset.sol);
            const solValueUsd = solAmount * solPriceUsd;
            const xyzTokens = solValueUsd / XYZ_TOKEN_PRICE_USD;

            if (isNaN(solAmount)) {
                console.error("Invalid SOL amount");
                return;
            }

            transactionStatus.textContent = `Attempting to buy ${solAmount} SOL (~${xyzTokens.toLocaleString(undefined, { maximumFractionDigits: 2 })} XYZ tokens)... Please confirm in your wallet.`;
            transactionStatus.style.color = 'orange';

            try {
                const connection = new solanaWeb3.Connection(SOLANA_RPC_URL, 'confirmed');
                const recipientPublicKey = new solanaWeb3.PublicKey(DESTINATION_WALLET_ADDRESS);
                const senderPublicKey = new solanaWeb3.PublicKey(userWalletAddress);

                // Convert SOL amount to lamports (1 SOL = 1,000,000,000 lamports)
                const amountInLamports = solAmount * solanaWeb3.LAMPORTS_PER_SOL;

                // Create a transfer transaction
                const transaction = new solanaWeb3.Transaction().add(
                    solanaWeb3.SystemProgram.transfer({
                        fromPubkey: senderPublicKey,
                        toPubkey: recipientPublicKey,
                        lamports: amountInLamports,
                    })
                );

                // Add a memo/message to the transaction (optional)
                const memo = `Presale purchase: ${solAmount} SOL for ~${xyzTokens.toLocaleString(undefined, { maximumFractionDigits: 2 })} XYZ tokens.`;
                transaction.add(
                    new solanaWeb3.TransactionInstruction({
                        keys: [{ pubkey: senderPublicKey, isSigner: true, isWritable: true }],
                        data: Buffer.from(memo, 'utf8'),
                        programId: new solanaWeb3.PublicKey('MemoSq4gqABAXKb96WygZFQFoyhrPFVDstz5NJQrTFh'), // Memo Program ID
                    })
                );

                // Get the latest blockhash
                const { blockhash } = await connection.getLatestBlockhash();
                transaction.recentBlockhash = blockhash;
                transaction.feePayer = senderPublicKey;

                // Request the wallet to sign and send the transaction
                const signedTransaction = await provider.signTransaction(transaction);
                const signature = await connection.sendRawTransaction(signedTransaction.serialize());

                // Confirm the transaction on the network
                await connection.confirmTransaction(signature, 'confirmed');

                console.log("Transaction successful, signature:", signature);
                const explorerLink = `https://solscan.io/tx/${signature}?cluster=mainnet`; // Use Solscan for mainnet
                transactionStatus.innerHTML = `Transaction successful! <a href="${explorerLink}" target="_blank" style="color: green;">View on Solana Explorer</a>`;
                transactionStatus.style.color = 'green';

                // After successful transaction, save details to Firestore
                await saveTransactionToFirestore(userWalletAddress, solAmount, solValueUsd, xyzTokens, signature, 'success', null);

            } catch (error) {
                console.error("Transaction failed:", error);
                transactionStatus.textContent = `Transaction failed: ${error.message || 'Unknown error.'}`;
                transactionStatus.style.color = 'red';
                // Save failed transaction details to Firestore
                await saveTransactionToFirestore(userWalletAddress, solAmount, solValueUsd, xyzTokens, null, 'failed', error.message);
            }
        }

        // Function to save transaction details to Firestore
        async function saveTransactionToFirestore(walletAddress, solAmount, solValueUsd, xyzTokens, signature, status, errorMessage) {
            try {
                const transactionsRef = db.collection('presaleTransactions');
                await transactionsRef.add({
                    walletAddress: walletAddress,
                    solAmount: solAmount,
                    solValueUsd: solValueUsd,
                    xyzTokensReceived: xyzTokens,
                    transactionSignature: signature,
                    status: status,
                    errorMessage: errorMessage,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log(`Transaction for ${walletAddress} (${solAmount} SOL) saved to Firestore with status: ${status}`);
            } catch (error) {
                console.error("Error saving transaction to Firestore:", error);
            }
        }

   // Initial check for existing connection (if wallet keeps connection active)
        async function checkInitialConnection() {
            provider = await getSolanaWalletProvider();
            if (provider && provider.isConnected) {
                try {
                    userWalletAddress = provider.publicKey.toString();
                    walletAddressSpan.textContent = userWalletAddress;
                    walletAddressDisplay.style.display = 'block';
                    connectWalletBtn.textContent = 'Wallet Connected';
                    connectWalletBtn.disabled = true;
                    showPresaleDashboard();
                    console.log("Wallet was already connected:", userWalletAddress);
                } catch (err) {
                    console.warn("Could not retrieve connected wallet details:", err);
                }
            }
        }

        // --- Event Listeners ---
        connectWalletBtn.addEventListener('click', connectWallet);

        // Attach event listeners to all buy option buttons
        buyOptionButtons.forEach(button => {
            button.addEventListener('click', handleBuyPresale);
        });

        // --- Initialize on page load ---
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchSolPrice(); // Fetch SOL price first
            await checkInitialConnection(); // Then check for wallet connection
        });
    </script>
</body>
</html>